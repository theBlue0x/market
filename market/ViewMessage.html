<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Blue0x Decentralized Marketplace">
  <link rel="shortcut icon" href="img/favicon.ico">
  <title>Blue0x | MARKET</title>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/bootstrap-reset.css" rel="stylesheet">
  <link href="assets/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
  <link href="css/style.min.css" rel="stylesheet">
  <link href="css/style-responsive.css" rel="stylesheet" />
  <link href="css/spinner.css" rel="stylesheet">
  <link href="assets/fancybox/jquery.fancybox.css" rel="stylesheet" />
  <link href="css/gallery.css" rel="stylesheet" />
  <script>
  function showMessage() {
      sessionStorage.removeItem("title");
      sessionStorage.removeItem("price");
      sessionStorage.removeItem("previous");
      sessionStorage.removeItem("recipient");
      var messageID = (getQueryVariable("messageid"));
    $.getJSON(Constants.apiUrl, {
        requestType: 'getPrunableMessage',
        transaction: messageID,
        secretPhrase: $("#secretPhrase").val()
      },
      function(request) {
        var sentFrom = escapeHtml(request.senderRS);
        sessionStorage.setItem("recipient", sentFrom);
        var data = JSON.parse(request.decryptedMessage);
        var title = escapeHtml(data.t);
        sessionStorage.setItem("title", title);
        var price = escapeHtml(data.p);
        sessionStorage.setItem("price", price);
        var previous = escapeHtml(data.o);
        if (previous === 'undefined') {
          previous = "N/A"
        }
        var message = escapeHtml(data.m);
        sessionStorage.setItem("previous", message);
        var result = '';
        result += '<h5><b>Item:</b></h5>';
        result += '<p>' + title + '</p>';
        result += '<h5><b>Item Price:</b></h5>';
        result += '<p>' + price + ' USDX </p>';
        result += '<span id="prevMessage"><h5><b>Previous Message:</b></h5>';
        result += '<p>' + previous + '</p></span>';
        result += '<h5><b>New Message:</b></h5>';
        result += '<p>' + message + '</p>';
        result += '<br/>';
        document.getElementById("panel-body").innerHTML = result;
        var buttons = "";
        buttons += '<a class="btn btn-default" href="ViewYourMessages.html">Back to Messages</a>&nbsp;<button class="btn btn-default" data-toggle="modal" data-target="#messageModal">Reply</button>';
        document.getElementById("messageButtonSection").innerHTML = buttons;
      })};
  </script>
  <script >
function docReady(fn) {
    if (document.readyState === "complete" || document.readyState === "interactive") {
        setTimeout(fn, 1);
    } else {
        document.addEventListener("DOMContentLoaded", fn);
    }} 
docReady(function() {
    var lastResult, countResults = 0;
    var html5QrcodeScanner = new Html5QrcodeScanner(
        "qr-reader1", { fps: 10, qrbox: 250 });
    function onScanSuccess(decodedText, decodedResult) {
        if (decodedText !== lastResult) {
            ++countResults;
            lastResult = decodedText;
            document.getElementById('secretPhrase').value = decodedText;
            html5QrcodeScanner.clear();
            setTimeout(function(){ $('#reader1').modal('hide'); }, 300);
        }}
    function onScanError(qrCodeError) {
    }
    html5QrcodeScanner.render(onScanSuccess, onScanError);
});
</script>
</head>
<body class="full-width" onload="setAccountNumber(); setLanguage();">
  <section id="container">
    <script type="text/javascript" src="js/menu.js"></script>
    <section id="main-content">
      <section class="wrapper">
        <div class="row">
          <div class="col-lg-12">
            <section class="panel">
              <header class="panel-heading" id="panel-heading">
                <span>Message</span>
              </header>
              <div class="panel-body" style="padding:20px;" id="panel-body">
                  <div class="form-group">
                    <label for="secretPhrase"><span data-i18n="secret_phrase">Account Secret Phrase</span></label>
                    <button type="button" class="btn btn-qr btn-xs" data-toggle="modal" data-target="#reader1">
                    <i class="fa fa-qrcode"></i>
                  </button>
                    <div class="iconic-input">
                      <i class="fa fa-key"></i>
                      <input type="password" class="form-control" id="secretPhrase" data-i18n="[placeholder]placeholder_required">
                    </div>
                  </div>
                </div>
              </div>
                  <div id="messageButtonSection" style="margin-left:15px">
                      <a type="button" class="btn btn-default" onclick="showMessage()">Show Message</a>
                    </div>
                    <!-- Message Modal -->
                    <div aria-hidden="true" aria-labelledby="messageModalLabel" role="dialog" tabindex="-1" id="messageModal" class="modal fade">
                        <div class="modal-dialog">
                          <div class="modal-content">
                            <div class="modal-header">
                              <button aria-hidden="true" data-dismiss="modal" class="close" type="button">Ã—</button>
                              <h4 class="modal-title">Reply</h4>
                            </div>
                            <div class="modal-body">
                          <div class="form-group">
                            <label for="reply"><b>Reply:</b> </label>
                            <textarea class="form-control" data-i18n="[placeholder]placeholder_required" cols="25" rows="4" id="reply" maxlength="203"></textarea>
                            </div>
                              <p><span>Please enter your account secret phrase to send this message.</span></p>
                              <div class="form-group">
                              <label for="secret_phrase_message"><b><span data-i18n="secret_phrase">Your Account Secret Phrase</span></b> :</label>
                              <div class="iconic-input">
                                <i class="fa fa-bars"></i>
                                <input type="password" class="form-control" data-i18n="[placeholder]placeholder_required" id="secret_phrase_message" autofocus>
                              </div>
                              <br/>
                                <button data-dismiss="modal" class="btn btn-secondary" type="button">Close</button>&nbsp;
                                <button data-dismiss="modal" class="btn btn-default" type="button" onclick="message()">Reply</button>
                            </div>
                            <p>The network fee of this transaction is 1 BLX.</p>
                            </div>
                          </div>
                        </div>
                      </div>
                    <!-- Message Modal-->
                    <div class="modal fade" style="top:10vh" id="reader1">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h4 class="modal-title">Scan Your Secret Phrase</h4>
                      </div>
                        <div class="modal-body" style="position: static">
                         <div id="qr-reader1"></div>
                        </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-info" data-dismiss="modal">Close</button>
                      </div>
                    </div> <!-- /.modal-content -->
                  </div> <!-- /.modal-dialog -->
                </div> <!-- /.modal -->
                  </div>
                </div>
              </div>
            </section>
          </div>
        </div>
        </div>
      </section>
    </section>
  </section>
  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/jquery.dcjqaccordion.2.7.min.js"></script>
  <script src="js/bootstrap-hover-dropdown.min.js"></script>
  <script src="assets/fancybox/jquery.fancybox.js"></script>
  <script src="js/validator.min.js"></script>
  <script type="text/javascript">
  $(function() {
    jQuery(".fancybox").fancybox();
  });
  </script>
  <script src="js/constants.js"></script>
  <script src="js/freemarket_scripts.js"></script>
  <script src="js/common-scripts.js"></script>
  <script src="js/i18next.min.js"></script>
  <script src="js/freemarket_localization_scripts.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.0.1/html5-qrcode.min.js"></script>
  <script>
    function message() {
      var recipient = sessionStorage.getItem("recipient");
      var messageContents = {
        t: sessionStorage.getItem("title"),
        p: sessionStorage.getItem("price"),
        o: sessionStorage.getItem("previous"),
        m: $("#reply").val()
      }
      $.post(Constants.apiUrl,{
        requestType: 'sendMessage',
        recipient: recipient,
        messageToEncryptIsText: 'true',
        encryptedMessageIsPrunable: 'true',
        messageToEncrypt: JSON.stringify(messageContents, null, 4),
        secretPhrase: $("#secret_phrase_message").val(),
        feeNQT: 100000000,
        deadline: 60
      },
      function(result){
        var errorCode = result.errorCode;
        if (!errorCode) {
          var transactionID = result.transaction;
          var success = $.t("success");
          document.getElementById("panel-heading").innerHTML = success;
          document.getElementById("panel-body").innerHTML = "<b> TX ID: " + transactionID + "</b><br/><br/>";
          document.getElementById("messageButtonSection").style.display = "none";
          sessionStorage.removeItem("title");
          sessionStorage.removeItem("price");
          sessionStorage.removeItem("previous");
          sessionStorage.removeItem("recipient");
          } else { 
          var errorDescription = result.errorDescription;
          var errorCode = result.errorCode;
          document.getElementById("listingResult").innerHTML = "<b> " + errorDescription + "</b>";
          };
      },"json");
    };
  </script>
</body>
</html>