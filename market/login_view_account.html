<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Blue0x Decentralized Marketplace">
  <link rel="shortcut icon" href="img/favicon.ico">
  <title>Blue0x | MARKET</title>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/bootstrap-reset.css" rel="stylesheet">
  <link href="assets/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
  <link href="css/style.min.css" rel="stylesheet">
  <link href="css/style-responsive.css" rel="stylesheet" />
  <script>
  function setButtonText() {
    // Translate the button text
    var translatedLoginButtonText = $.t("button_login");
    document.getElementById("loginButtonText").innerHTML = translatedLoginButtonText;
  };
  </script>
  <script>
  function login() {
    // Get the account number
    var Account = document.getElementById('user_entered_account_number').value;
    if (!Account) { // Form validation
      document.getElementById("user_entered_account_numberErrorMessage").innerHTML = "<p>Account Number Required</p>";
    } else {
      // Set the RS account number as a variable
      var currentRSAccountNumber =$('#user_entered_account_number').val();
      // POST the request
      $.post(Constants.apiUrl, {
        requestType: 'getAccount',
        account: $('#user_entered_account_number').val(),
        includeEffectiveBalance: "true"
      },
      function(result) {
          console.log(result);
          if (result.errorDescription == 'Unknown account') { // If this is not a valid account number
            document.getElementById("user_entered_account_numberErrorMessage").innerHTML = "<p class=\"validation_message\">New or invalid BLX account.  New BLX accounts must first make an outgoing transaction from the Blue0x wallet.</p>";
            } else {
            // Store the account number and balance
            sessionStorage.setItem("accountRS", result.accountRS);
            sessionStorage.setItem("accountBalance", result.effectiveBalanceNXT);
            console.log('BLX Balance is ' + result.effectiveBalanceNXT)
            // Display the logged in account number and balance and remove the Log In button
            var replace_loginResult = '';
            replace_loginResult += '<div class="media-body">';
            replace_loginResult += '<p>You have logged in with the following account:</p>';
            replace_loginResult += '<a class="p-head">Account ID</a>';
            replace_loginResult += '<p>' + result.accountRS + '</p>';
            replace_loginResult += '</div>';
            replace_loginResult += '<div class="media-body">';
            replace_loginResult += '<a class="p-head">BLX Balance</a>';
            replace_loginResult += '<p>' + result.effectiveBalanceNXT + ' BLX </p>';
            replace_loginResult += '</div>';
            document.getElementById("loginResult").innerHTML = replace_loginResult;
          }
        }, "json");
      // Get USDX balance for this account and display it
      $.post(Constants.apiUrl, {
        requestType: 'getAccountCurrencies',
        account: currentRSAccountNumber,
      },
      function(coinquery) {
        console.log(coinquery)
        if (coinquery.accountCurrencies.length == 0) {
            // If this account does not have any USDX
            console.log('There is no USDX associated with this account.');
            sessionStorage.setItem("USDXAccountBalance", "0 USDX");
            // Display the USDX balance as zero
            var replace_USDXAccountBalance = '';
            replace_USDXAccountBalance += '<div class="media-body">';
            replace_USDXAccountBalance += '<a class="p-head">USDX Balance</a>';
            replace_USDXAccountBalance += '<p>0 USDX</p>';
            replace_USDXAccountBalance += '</div>';
            replace_USDXAccountBalance += '</br>';
            replace_USDXAccountBalance += '<a class="btn btn-default" href="ViewAll.html" role="button">View Items</a>&nbsp;&nbsp;<a class="btn btn-default" href="ListNewItem.html" role="button">List New Item</a>';
            document.getElementById("USDXAccountBalance").innerHTML = replace_USDXAccountBalance;
          } else {
            console.log("USDX Balance is " + coinquery.units);
            var USDXAccountBalance = coinquery.units;
            sessionStorage.setItem("USDXAccountBalance", coinquery.units);
            // Convert it to decimal notation
            var convertedUSDXAccountBalance = USDXAccountBalance / 100;
            // Display the USDX balance
            var replace_USDXAccountBalance = '';
            replace_USDXAccountBalance += '<div class="media-body">';
            replace_USDXAccountBalance += '<a class="p-head">USDX Balance</a>';
            replace_USDXAccountBalance += '<p>' + convertedUSDXAccountBalance + ' USDX</p>';
            replace_USDXAccountBalance += '</div>';
            replace_USDXAccountBalance += '</br>';
            replace_USDXAccountBalance += '<a class="btn btn-default" href="ViewAll.html" role="button">View Items</a>&nbsp;&nbsp;<a class="btn btn-default" href="ListNewItem.html" role="button">List New Item</a>';
            document.getElementById("USDXAccountBalance").innerHTML = replace_USDXAccountBalance;
          }
        }, "json");
    }};
</script>
  <script>
  function loadAccountInfo() {
    // If account number already set, redirect to Change Account Info page
    if (sessionStorage.getItem("loginStatus") == "loggedin") {
      // Redirect to Change Account page
      var fmlang = localStorage.getItem("fmlang");
      window.location.assign("account_details.html?setLng=" + fmlang);
    }};
  </script>
</head>
<body class="full-width" onload="loadAccountInfo(); setLanguage(); setButtonText();">
  <section id="container">
    <script type="text/javascript" src="js/menu.js"></script>
    <section id="main-content">
      <section class="wrapper">
        <div class="row">
          <div class="col-lg-12">
            <section class="panel">
              <header class="panel-heading">
                <b><span data-i18n="header_login">Log In</span></b>
              </header>
              <div class="panel-body">
                <div id="loginResult">
                  <p><span data-i18n="account_number_welcome">Enter your BLX account number below. This will allow Blue0x Market to know which items for sale are yours, and to display your BLX account balance. Your secret passphrase is NOT required for this.</span></p>
                  <div class="form-group">
                    <label for="user_entered_account_number"><span data-i18n="account_number">BLX Account Number</span></label>
                    <div class="iconic-input">
                      <i class="fa fa-bars"></i>
                      <input type="text" class="form-control" data-i18n="[placeholder]placeholder_required" id="user_entered_account_number" autofocus>
                      <div id="user_entered_account_numberErrorMessage"></div>
                    </div>
                  </div>
                  <div id="loginButtonSection">
                    <button type="button" id="loginButton" class="btn btn-default" onclick="login();">
                      <div id="loginButtonText"></div>
                    </button>
                  </div>
                </div>
                <div id="USDXAccountBalance">
                </div>
              </div>
            </section>
          </div>
      </section>
      </div>
    </section>
  </section>
  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/jquery.dcjqaccordion.2.7.min.js"></script>
  <script src="js/bootstrap-hover-dropdown.min.js"></script>
  <script src="js/constants.js"></script>
  <script src="js/freemarket_scripts.js"></script>
  <script src="js/common-scripts.js"></script>
  <script src="js/i18next.min.js"></script>
  <script src="js/freemarket_localization_scripts.js"></script>
</body>
</html>